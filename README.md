# üì¶ bsm2-tools

**BSM2 Tools** is a Python library for analyzing data from wastewater treatment plant simulations based on the Benchmark Simulation Model No. 2 (BSM2). It includes tools for loading, visualizing, and evaluating plant performance and regulatory violations.

## üìò What is BSM2?

The **Benchmark Simulation Model No. 2 (BSM2)** is a widely used simulation framework for wastewater treatment plants (WWTPs).  
It allows researchers and engineers to test control strategies, evaluate operational performance, and optimize treatment processes without needing real-time plant data.

In BSM2, a detailed dynamic model simulates the biological and chemical processes of a WWTP, including:

- Influent characteristics (e.g., flow, organic matter, nitrogen forms)
- Primary clarifier
- Activated sludge reactor
- Secondary clarifier
- Sludge handling and digestion

Data generated by BSM2 includes dozens of process variables every 15 minutes, typically stored as `.csv` or `.mat` files.

---

## üìÇ Input CSV requirements

To use the analyzer functions correctly, the input `.csv` file must include the following:

- A **`D√≠a`** column containing dates or timestamps.
- **Target output variables**, such as:  
  - `DBO_salida (mg/L)`  
  - `DQO_salida (mg/L)`  
  - `SST_salida (mg/L)`  
  - `Ntot_salida (mg/L)`  
  - `NH_salida (mg/L)`  
  - `PT_salida (mg/L)`

- **Operational variables** used in causal analysis:
  - `F/M`  
  - `TRC (d-1)`  
  - `TRH (h)`  
  - `Recir. Interna (m3/d)`  
  - `Recir. Externa (m3/d)`

- **Influent disturbance indicators**, such as:
  - `Q (m3/d)`
  - `Temperatura (¬∫C)`
  - `DQO_brut (mg/L)`
  - `DBO_brut (mg/L)`
  - `SST_brut (mg/L)`
  - `NH_brut (mg/L)`

> ‚ö†Ô∏è **Important:** The column names must match exactly as shown. If your dataset uses different headers, you should modify the functions accordingly.

![alt text](image.png)

## üöÄ Features

- Load and process BSM2 CSV output files
- Visualize influent and effluent trends over time
- Detect violations of environmental discharge limits
- Analyze causal relationships between operational settings and violations
- Visualize cause ‚Üí explanation ‚Üí response with Sankey diagrams

## üõ†Ô∏è Installation

Clone this repo and install the dependencies in a virtual environment:

```bash
git clone https://github.com/your-username/bsm2-tools.git
cd bsm2-tools
python -m venv .venv
source .venv/bin/activate  # On Windows: .venv\Scripts\activate
pip install -r requirements.txt
# bsm2-tools
```

## üìä `analyzer` module ‚Äî Violation detection and causal analysis engine

![alt text](image-2.png)

The `analyzer` module is responsible for identifying regulatory violations in wastewater treatment plant datasets (e.g. BSM2 simulations or real plant data), and analyzing potential causes and operational responses. It includes:

- **Violation detection**: For key effluent quality parameters (e.g. COD, BOD, TSS, TN, NH‚ÇÑ‚Å∫, TP), it detects days where values exceed legal or design thresholds.
- **Causal analysis**: For each violation, it analyzes:
  - **Direct causes**: based on abnormal behavior of operational variables (e.g. low sludge age, high F/M ratio) compared to short-term historical trends.
  - **Secondary causes**: based on external perturbations (e.g. rain events, organic or nitrogen shock loads).
- **Response detection**: It checks whether any corrective operational actions were taken in the following days (e.g. increasing internal recirculation).
- **Sankey visualization**: It generates Sankey diagrams showing how direct causes, secondary explanations and operator actions are linked for each type of violation.

The module is designed to work with daily resolution data, assuming a DataFrame with typical WWTP columns (e.g. flows, temperatures, influent/effluent concentrations, operational parameters).

### üß† Key Function


## üéØ `visualizer` module ‚Äî Sankey diagram for violations and causes

The `visualizer` module provides an intuitive way to understand **why** effluent quality violations occurred and **how** the system responded. It builds on the output of the `analyzer` module and produces Sankey diagrams that map:

- **Direct causes** (e.g., poor sludge age, high F/M)
- **Secondary explanations** (e.g., shock loads, temperature drops)
- **Operational responses** (e.g., increased recirculation)

### üß† Key Function

```python
from bsm2tools.analyzer import analizar_violaciones
from bsm2tools.visualizer import graficar_sankey_causas_explicaciones

df = pd.read_csv("mi_archivo.csv")
df_resultados = analizar_violaciones(df)
graficar_sankey_causas_explicaciones(df_resultados, variable_objetivo="DBO_salida (mg/L)")

